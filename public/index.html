<!DOCTYPE html>
<html>
  <head>
    <title>Standing Desk</title>
    <style>
      body {
        background-color: whitesmoke;
        font-size: 0.8em;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
      }

      input {
        padding: 10px;
      }

      button {
        padding: 10px;
        border-radius: 4px;
      }

      main {
            background-color: white;
            padding: 40px;
            box-sizing: border-box;
            max-width: 800px;
            margin: 0px auto;
            box-shadow: 0 19px 38px rgba(0,0,0,0.30), 0 15px 12px rgba(0,0,0,0.22);
      }
    </style>
  </head>
  <body>
    <main>
      <h3>Standing Desk</h3>
      <input type="text"></input>
      <button type="submit">Set height</button>

      <label></label>
    </main>

    <script>
      const connection = new EventSource('/state') //, { withCredentials: true })

      connection.addEventListener('error', function (e) {
        console.log('there was an error in the connection listener SSE:', e)
        if (e.readyState == EventSource.CLOSED)
          console.log('SSE connection was closed')
      })

      connection.addEventListener('open', function(e) {
        console.log('SSE Connection is opened', e)
      }, false)

      connection.addEventListener('message', function (e) {
        console.log('msg:', e.data)
        const data = JSON.parse(e.data)
        document.body.querySelector('label').innerText = `height: ${data.deskState.height.toFixed(1)}"  state: ${data.deskState.state}`
      })

      const button = document.body.querySelector('button')
      button.onclick = function (e) {
        e.preventDefault()

        const height = document.body.querySelector('input').value
        console.log('sending:', height)
        const xhr = new XMLHttpRequest()
        xhr.open("POST", '/height?height='+height, true)
        xhr.setRequestHeader('Content-Type', 'application/json')
        xhr.send(JSON.stringify({
            height
        }))

        return false
      }

    </script>
  </body>
</html>
