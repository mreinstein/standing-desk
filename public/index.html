<!DOCTYPE html>
<html>
  <head>
    <title>Standing Desk</title>
  </head>
  <body>
    Standing Desk

    <input type="text"></input>
    <button type="submit">Set height</button>

    <label></label>

    <script>
      const connection = new EventSource('/state') //, { withCredentials: true })

      connection.addEventListener('error', function (e) {
        console.log('there was an error in the connection listener SSE:', e)
        if (e.readyState == EventSource.CLOSED)
          console.log('SSE connection was closed')
      })

      connection.addEventListener('open', function(e) {
        console.log('SSE Connection is opened', e)
      }, false)

      connection.addEventListener('message', function (e) {
        console.log('msg:', e.data)
        const data = JSON.parse(e.data)
        document.body.querySelector('label').innerText = `height: ${data.deskState.height.toFixed(1)}"  state: ${data.deskState.state}`
      })

      const button = document.body.querySelector('button')
      button.onclick = function (e) {
        e.preventDefault()

        const height = document.body.querySelector('input').value
        console.log('sending:', height)
        const xhr = new XMLHttpRequest()
        xhr.open("POST", '/height?height='+height, true)
        xhr.setRequestHeader('Content-Type', 'application/json')
        xhr.send(JSON.stringify({
            height
        }))

        return false
      }

    </script>
  </body>
</html>
